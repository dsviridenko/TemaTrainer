# TemaTrainer

**TemaTrainer** โ ััะพ ัะบัะฟะตัะธะผะตะฝัะฐะปัะฝัะน ะบะปะฐัั ะดะปั ะดะพะพะฑััะตะฝะธั ะฑะพะปััะธั ัะทัะบะพะฒัั ะผะพะดะตะปะตะน (LLM), ัะตะฐะปะธะทัััะธะน ะฟะพะดัะพะด **Teacher Exponential Moving Average (TEMA)**. ะะฐะฝะฝัะน ะผะตัะพะด ะฟัะตะดะฝะฐะทะฝะฐัะตะฝ ะดะปั ัะตะณัะปััะธะทะฐัะธะธ ะฟัะพัะตััะฐ ะพะฑััะตะฝะธั ะธ ัะฝะธะถะตะฝะธั ัััะตะบัะฐ *catastrophic forgetting* (ะบะฐัะฐัััะพัะธัะตัะบะพะณะพ ะทะฐะฑัะฒะฐะฝะธั) ะฟัะธ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพะผ (continual) fine-tuning ะฝะฐ ะดะพะผะตะฝะฝะพ-ัะฟะตัะธัะธัะฝัั ะดะฐะฝะฝัั.

ะะตะฐะปะธะทะฐัะธั ะฟะพัััะพะตะฝะฐ ะบะฐะบ ัะฐััะธัะตะฝะธะต ะฑะธะฑะปะธะพัะตะบะธ `trl` (ะบะปะฐัั `SFTTrainer`) ะธ ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะฐ ะดะปั ััะตะฝะฐัะธะตะฒ **PEFT** (Parameter-Efficient Fine-Tuning), ะฒ ะฟะตัะฒัั ะพัะตัะตะดั ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ะฐะดะฐะฟัะตัะพะฒ **LoRA**.

---

## ๐ง ะะพัะธะฒะฐัะธั

ะัะธ ััะฐะฝะดะฐััะฝะพะผ ะพะฑััะตะฝะธะธ ั ััะธัะตะปะตะผ (Supervised Fine-Tuning, SFT) ะฝะฐ ัะทะบะพัะฟะตัะธะฐะปะธะทะธัะพะฒะฐะฝะฝัั ะดะฐะฝะฝัั LLM ัะฐััะพ ััะฐะปะบะธะฒะฐัััั ัะพ ัะปะตะดัััะธะผะธ ะฟัะพะฑะปะตะผะฐะผะธ:

*   ๐ **ะะตะณัะฐะดะฐัะธั ะบะฐัะตััะฒะฐ** ะฝะฐ ะพะฑัะธั ะทะฐะดะฐัะฐั (General Capabilities).
*   ๐คฏ **Catastrophic Forgetting** โ ะฟะพัะตัั ัะฐะฝะตะต ะฒัััะตะฝะฝัั ะทะฝะฐะฝะธะน.
*   ๐ฏ **Overfitting** โ ะฟะตัะตะพะฑััะตะฝะธะต ะฝะฐ ัะตะบััะตะผ, ัะทะบะพะผ ะดะพะผะตะฝะต.

ะะปะฐััะธัะตัะบะธะผ ัะตัะตะฝะธะตะผ ัะฒะปัะตััั ะธัะฟะพะปัะทะพะฒะฐะฝะธะต *Teacher-Student* ะดะธััะธะปะปััะธะธ, ะณะดะต ััะธัะตะปั ะทะฐะดะฐะตั ััะฐะฑะธะปัะฝะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต ะฒะตัะพััะฝะพััะตะน (logits). ะะดะฝะฐะบะพ ััะฐะฝะตะฝะธะต ะฟะพะปะฝะพะน ะบะพะฟะธะธ ะผะพะดะตะปะธ-ััะธัะตะปั ะฒ ะฟะฐะผััะธ (ะพัะพะฑะตะฝะฝะพ ะดะปั ะผะพะดะตะปะตะน ััะพะฒะฝั 7B, 70B ะธ ะฒััะต) ัะฐััะพ ะฝะตะฟัะฐะบัะธัะฝะพ ะธะปะธ ะฝะตะฒะพะทะผะพะถะฝะพ.

**TemaTrainer** ัะตัะฐะตั ััั ะฟัะพะฑะปะตะผั, ะธัะฟะพะปัะทัั EMA-ะฒะตััะธั ััะธัะตะปั, ะบะพัะพัะฐั ััะฐะฝะธััั ะธ ะพะฑะฝะพะฒะปัะตััั **ัะพะปัะบะพ ะดะปั ะพะฑััะฐะตะผัั ะฟะฐัะฐะผะตััะพะฒ (LoRA)**.

---

## ๐ก ะัะฝะพะฒะฝะฐั ะธะดะตั (TEMA)

ะะผะตััะพ ะดัะฑะปะธัะพะฒะฐะฝะธั ะฒัะตะน ะผะพะดะตะปะธ ะธัะฟะพะปัะทัะตััั ัะปะตะดัััะฐั ััะตะผะฐ:

1.  **Student** โ ะพัะฝะพะฒะฝะฐั ะผะพะดะตะปั, ะพะฑััะฐะตะผะฐั ััะฐะฝะดะฐััะฝัะผ ะผะตัะพะดะพะผ SFT.
2.  **Teacher (EMA)** โ ะฒะธัััะฐะปัะฝะฐั ะผะพะดะตะปั, ะฟัะตะดััะฐะฒะปัััะฐั ัะพะฑะพะน ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝะพ ัััะตะดะฝัะฝะฝัั ะฒะตััะธั *ัะพะปัะบะพ* LoRA-ะฟะฐัะฐะผะตััะพะฒ ัััะดะตะฝัะฐ.

### ะะปะณะพัะธัะผ ัะฐะณะฐ ะพะฑััะตะฝะธั:

1.  ะััะธัะปัะตััั ััะฐะฝะดะฐััะฝะฐั ััะฝะบัะธั ะฟะพัะตัั **Cross-Entropy** ะดะปั ัะตะบััะตะณะพ ะฑะฐััะฐ.
2.  ะัะพะธะทะฒะพะดะธััั ะฒัะตะผะตะฝะฝะฐั **ะฟะพะดะผะตะฝะฐ ะฒะตัะพะฒ** LoRA ะฝะฐ ะธั EMA-ะฒะตััะธะธ (Teacher).
3.  ะััะธัะปัะตััั **KL-ะดะธะฒะตัะณะตะฝัะธั** ะผะตะถะดั ัะฐัะฟัะตะดะตะปะตะฝะธัะผะธ ัััะดะตะฝัะฐ ะธ ััะธัะตะปั.
4.  ะะตัะฐ ะฒะพะทะฒัะฐัะฐัััั ะฒ ะธััะพะดะฝะพะต ัะพััะพัะฝะธะต, ะฐ EMA-ัะพััะพัะฝะธะต ะพะฑะฝะพะฒะปัะตััั.

### ะคัะฝะบัะธั ะฟะพัะตัั

ะัะพะณะพะฒะฐั ััะฝะบัะธั ะฟะพัะตัั ะฒัะณะปัะดะธั ัะปะตะดัััะธะผ ะพะฑัะฐะทะพะผ:

$$
L = \alpha \cdot L_{CE} + \beta \cdot L_{KL}
$$

ะะดะต:
*   $L_{CE}$ โ ะพัะธะฑะบะฐ ะฟะตัะตะบัะตััะฝะพะน ัะฝััะพะฟะธะธ (Cross-Entropy Loss).
*   $L_{KL}$ โ ะดะธะฒะตัะณะตะฝัะธั ะัะปัะฑะฐะบะฐ-ะะตะนะฑะปะตัะฐ ะผะตะถะดั ะฒััะพะดะฐะผะธ ัััะดะตะฝัะฐ ะธ EMA-ััะธัะตะปั.
*   $\alpha, \beta$ โ ะบะพัััะธัะธะตะฝัั ะฒะทะฒะตัะธะฒะฐะฝะธั.

---

## โญ ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ

*   โ **ะญััะตะบัะธะฒะฝะพััั ะฟะฐะผััะธ:** EMA ััะฐะฝะธััั ัะพะปัะบะพ ะดะปั ะฟะฐัะฐะผะตััะพะฒ ั `requires_grad=True` (LoRA-ะฐะดะฐะฟัะตัั). ะะพะปะฝะฐั ะบะพะฟะธั ะผะพะดะตะปะธ ะฝะต ััะตะฑัะตััั.
*   โ **PEFT-ัะพะฒะผะตััะธะผะพััั:** ะะพะปะฝะฐั ะฟะพะดะดะตัะถะบะฐ LoRA ะธ QLoRA.
*   โ **ะะฝัะตะณัะฐัะธั:** ะะตะณะบะพ ะฒัััะฐะธะฒะฐะตััั ะฒ ัััะตััะฒัััะธะต ะฟะฐะนะฟะปะฐะนะฝั ะฝะฐ ะฑะฐะทะต `trl`.
*   โ **4-bit Support:** ะะพะดะดะตัะถะบะฐ ะบะฒะฐะฝัะพะฒะฐะฝะฝัั ะผะพะดะตะปะตะน (bitsandbytes), ะฟัะธ ััะปะพะฒะธะธ, ััะพ ะฑะฐะทะพะฒะฐั ะผะพะดะตะปั ะทะฐะผะพัะพะถะตะฝะฐ.
*   โ **ะะตะณัะปััะธะทะฐัะธั:** ะกะฝะธะถะฐะตั ัะธัะบ ะฟะตัะตะพะฑััะตะฝะธั ะธ "ะดัะตะนัะฐ" ะฒะตัะพะฒ.

---

## ๐ ะััะธัะตะบัััะฐ

```mermaid
graph TD;
    Input[ะัะพะดะฝัะต ะดะฐะฝะฝัะต] --> Student;
    Input --> TeacherEMA;
    
    subgraph "Training Step"
        Student(Student Model<br/>LoRA Weights) -->|Logits| CE[Cross-Entropy Loss];
        TeacherEMA(Teacher Model<br/>EMA LoRA Weights) -->|Logits| KL[KL-Divergence];
        
        CE --> TotalLoss;
        KL --> TotalLoss[Total Loss];
    end
    
    TotalLoss --> Update[Backpropagation];
    Update -->|Update Weights| Student;
    Student -.->|EMA Update| TeacherEMA;
```

*ะกัะตะผะฐัะธัะฝะพะต ะฟัะตะดััะฐะฒะปะตะฝะธะต ะฟัะพัะตััะฐ:*

```text
                โโโโโโโโโโโโโโโโ
                โ   Student    โ
                โ  (LoRA)      โ
                โโโโโโโโฌโโโโโโโโ
                       โ logits
                       โผ
                Cross-Entropy
                       โ
                       โผ
               Student loss
                       โ
        โโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโ
        โ                             โ
        โผ                             โผ
 EMA update                     EMA weights
 (LoRA only)                        (Teacher)
        โ                             โ
        โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ
                       โผ
                  KL-divergence
```

---

## ๐ ะะพะณะดะฐ ะธัะฟะพะปัะทะพะฒะฐัั TemaTrainer

ะญัะพั ะผะตัะพะด ะพัะพะฑะตะฝะฝะพ ะฟะพะปะตะทะตะฝ ะฒ ัะปะตะดัััะธั ััะตะฝะฐัะธัั:

*   **Continual Fine-Tuning:** ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพะต ะพะฑััะตะฝะธะต ะผะพะดะตะปะธ ะฝะฐ ะฝะตัะบะพะปัะบะธั ะดะพะผะตะฝะฐั ะฑะตะท ะฟะพัะตัะธ ะทะฝะฐะฝะธะน ะฟัะตะดัะดััะธั.
*   **Noisy Data:** ะะพะพะฑััะตะฝะธะต ะฝะฐ ัะทะบะธั ะธะปะธ ะทะฐััะผะปะตะฝะฝัั ะดะฐัะฐัะตัะฐั, ะณะดะต ะฒััะพะบ ัะธัะบ ะฟะตัะตะพะฑััะตะฝะธั.
*   **Safety & General Abilities:** ะะตะพะฑัะพะดะธะผะพััั ัะพััะฐะฝะธัั ะพะฑัะธะต ัะฟะพัะพะฑะฝะพััะธ ะผะพะดะตะปะธ (chat, reasoning) ะฟัะธ ะฒะฝะตะดัะตะฝะธะธ ัะฟะตัะธัะธัะฝัั ะทะฝะฐะฝะธะน.
*   **Low-Resource:** ะะณัะฐะฝะธัะตะฝะฝัะต ัะตััััั GPU, ะฝะต ะฟะพะทะฒะพะปัััะธะต ะทะฐะณััะทะธัั ะฒัะพััั ะผะพะดะตะปั-ััะธัะตะปั ะฒ ะฟะฐะผััั.

---

## โ๏ธ ะะตะฐะปะธะทะฐัะธั

`TemaTrainer` ะฝะฐัะปะตะดัะตััั ะพั `trl.SFTTrainer` ะธ ะฟะตัะตะพะฟัะตะดะตะปัะตั ะปะพะณะธะบั ะฒััะธัะปะตะฝะธั ะปะพััะฐ.

*   **ะฅัะฐะฝะตะฝะธะต ัะพััะพัะฝะธั:** EMA-ะบะพะฟะธะธ ะฒะตัะพะฒ ััะฐะฝัััั ะฒ ัะปะพะฒะฐัะต `self.ema_state`.
*   **ะะฑะฝะพะฒะปะตะฝะธะต:** ะะตัะตััะตั ัะบะพะปัะทััะตะณะพ ััะตะดะฝะตะณะพ ะฒัะฟะพะปะฝัะตััั ะฟะพัะปะต ะบะฐะถะดะพะณะพ ัะฐะณะฐ ะพะฟัะธะผะธะทะฐัะพัะฐ.
*   **Inference ะฃัะธัะตะปั:** ะะปั ะฟะพะปััะตะฝะธั ะปะพะณะธัะพะฒ ััะธัะตะปั ัะตะบััะธะต ะฒะตัะฐ ะฐะดะฐะฟัะตัะพะฒ ะฒัะตะผะตะฝะฝะพ ะทะฐะผะตะฝััััั ะฝะฐ ะฒะตัะฐ ะธะท `self.ema_state`, ะดะตะปะฐะตััั ะฟัะพัะพะด (forward pass), ะฟะพัะปะต ัะตะณะพ ะฒะตัะฐ ะฒะพะทะฒัะฐัะฐัััั ะพะฑัะฐัะฝะพ. ะะฐะทะพะฒะฐั ะผะพะดะตะปั (frozen base model) ะพััะฐะตััั ะฝะตะธะทะผะตะฝะฝะพะน ะธ ะธัะฟะพะปัะทัะตััั ะพะฑะพะธะผะธ "ะฐะณะตะฝัะฐะผะธ".
